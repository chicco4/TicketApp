<section class="page page--wide organizer-events">
  <header class="page__header">
    <div class="page__intro">
      <h1 class="page__title">Manage Events</h1>
      <p class="page__subtitle">Review schedules, adjust ticket tiers, and retire events that are no longer needed.</p>
    </div>
    <div class="page__toolbar">
      <a mat-stroked-button color="accent" routerLink="/organizer/create-event">
        <mat-icon>add_circle</mat-icon>
        <span>Create event</span>
      </a>
    </div>
  </header>

  @if (showQuickGuide) {
    <div class="organizer-guide">
      <app-quick-guide-card
        [avatarIcon]="organizerQuickGuide.icon"
        [title]="organizerQuickGuide.title"
        [subtitle]="organizerQuickGuide.subtitle"
        [steps]="organizerQuickGuide.steps"
        (dismissed)="showQuickGuide = false"
      />
    </div>
  }

  @if (submissionSuccess) {
    <div class="alert success">
      <mat-icon>check_circle</mat-icon>
      <span>{{ submissionSuccess }}</span>
    </div>
  }

  @if (error) {
    <div class="alert error">
      <mat-icon>error_outline</mat-icon>
      <span>{{ error }}</span>
    </div>
  }

  @if (loading) {
    <div class="loading-container">
      <mat-progress-spinner diameter="48" strokeWidth="4" mode="indeterminate"></mat-progress-spinner>
    </div>
  }

  @if (!loading && events.length) {
    <section class="events-grid">
      @for (event of events; track trackByEventId($index, event)) {
        <mat-card appearance="outlined" class="event-card">
          @let deleting = isDeleting(event.id);

          <mat-card-header>
            <div mat-card-avatar class="card-avatar">
              <mat-icon>event</mat-icon>
            </div>
            <mat-card-title>{{ event.name }}</mat-card-title>
            <mat-card-subtitle>{{ event.status }} &middot; {{ event.type }}</mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <div class="meta-grid">
              <div>
                <span class="label">Venue</span>
                <p>{{ event.venue }}</p>
              </div>
              <div>
                <span class="label">Starts</span>
                <p>{{ event.start | date: 'medium' }}</p>
              </div>
              <div>
                <span class="label">Ends</span>
                <p>{{ event.end | date: 'medium' }}</p>
              </div>
              <div>
                <span class="label">Sales window</span>
                <p>
                  <span>{{ event.salesStart ? (event.salesStart | date: 'medium') : 'Not set' }}</span>
                  <span> - </span>
                  <span>{{ event.salesEnd ? (event.salesEnd | date: 'medium') : 'Not set' }}</span>
                </p>
              </div>
            </div>

            @if (event.description) {
              <span class="label">Description</span>
              <p class="description">{{ event.description }}</p>
            }

            <mat-divider></mat-divider>

            <div class="ticket-types">
              <h3>Ticket types</h3>
              @if (event.ticketTypes.length) {
                <mat-list>
                  @for (ticket of event.ticketTypes; track trackTicketType($index, ticket)) {
                    <mat-list-item>
                      <mat-icon matListItemIcon>confirmation_number</mat-icon>
                      <div matListItemTitle>{{ ticket.name }}</div>
                      <div matListItemLine>
                        <span>{{ ticket.price | money }}</span>
                        @if (ticket.totalAvailable !== undefined) {
                          <span> &middot; {{ ticket.totalAvailable }} available</span>
                        }
                      </div>
                    </mat-list-item>
                  }
                </mat-list>
              } @else {
                <p class="no-tickets">No ticket types configured for this event.</p>
              }
            </div>
          </mat-card-content>

          <mat-card-actions>
            <button mat-stroked-button color="primary" type="button" [routerLink]="['/organizer/update-event', event.id]" [disabled]="deleting">
              <mat-icon>edit</mat-icon>
              <span>Edit</span>
            </button>
            <button mat-stroked-button color="warn" type="button" (click)="deleteEvent(event)" [disabled]="deleting">
              @if (deleting) {
                <mat-progress-spinner class="inline-spinner" diameter="20" strokeWidth="3" mode="indeterminate"></mat-progress-spinner>
              } @else {
                <mat-icon>delete</mat-icon>
              }
              <span>{{ deleting ? 'Deletingâ€¦' : 'Delete' }}</span>
            </button>
          </mat-card-actions>
        </mat-card>
      }
    </section>
  }

  @if (page; as pageData) {
    @if (pageData.totalPages > 1) {
      <mat-paginator
        [length]="pageData.totalElements"
        [pageIndex]="pageData.number"
        [pageSize]="pageData.size"
        [pageSizeOptions]="[pageData.size]"
        (page)="onPageChange($event)"
      ></mat-paginator>
    }
  }

  @if (!loading && !events.length && !error) {
    <div class="empty-state">
      <mat-icon>lightbulb</mat-icon>
      <h2>No events yet</h2>
      <p>Create your first event to start selling tickets.</p>
    </div>
  }
</section>
