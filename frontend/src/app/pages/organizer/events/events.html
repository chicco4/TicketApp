<div class="page-container">
  <section class="page-header">
    <div class="page-intro">
      <h1>Manage Events</h1>
      <p>Review schedules, adjust ticket tiers, and retire events that are no longer needed.</p>
    </div>
    <a mat-stroked-button color="accent" routerLink="/organizer/create-event">
      <mat-icon>add_circle</mat-icon>
      <span>Create event</span>
    </a>
  </section>

  <div class="alert success" *ngIf="submissionSuccess">
    <mat-icon>check_circle</mat-icon>
    <span>{{ submissionSuccess }}</span>
  </div>

  <div class="alert error" *ngIf="submissionError">
    <mat-icon>error</mat-icon>
    <span>{{ submissionError }}</span>
  </div>

  <div class="alert error" *ngIf="error">
    <mat-icon>error_outline</mat-icon>
    <span>{{ error }}</span>
  </div>

  <div class="loading-container" *ngIf="loading">
    <mat-progress-spinner diameter="48" strokeWidth="4" mode="indeterminate"></mat-progress-spinner>
  </div>

  <section class="events-grid" *ngIf="!loading && events.length; else noEvents">
  <mat-card appearance="outlined" class="event-card" *ngFor="let event of events; trackBy: trackByEventId">
      <mat-card-header>
        <div mat-card-avatar class="card-avatar">
          <mat-icon>event</mat-icon>
        </div>
        <mat-card-title>{{ event.name }}</mat-card-title>
        <mat-card-subtitle>{{ event.status }} &middot; {{ event.type }}</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="meta-grid">
          <div>
            <span class="label">Venue</span>
            <p>{{ event.venue }}</p>
          </div>
          <div>
            <span class="label">Starts</span>
            <p>{{ event.start | date: 'medium' }}</p>
          </div>
          <div>
            <span class="label">Ends</span>
            <p>{{ event.end | date: 'medium' }}</p>
          </div>
          <div>
            <span class="label">Sales window</span>
            <p>
              <span>{{ event.salesStart ? (event.salesStart | date: 'medium') : 'Not set' }}</span>
              <span> - </span>
              <span>{{ event.salesEnd ? (event.salesEnd | date: 'medium') : 'Not set' }}</span>
            </p>
          </div>
        </div>

        <p class="description" *ngIf="event.description">{{ event.description }}</p>

        <mat-divider></mat-divider>

        <div class="ticket-types">
          <h3>Ticket types</h3>
          <mat-list *ngIf="event.ticketTypes?.length; else noTickets">
            <mat-list-item *ngFor="let ticket of event.ticketTypes; trackBy: trackTicketType">
              <mat-icon matListItemIcon>confirmation_number</mat-icon>
              <div matListItemTitle>{{ ticket.name }}</div>
              <div matListItemLine>
                <span>${{ ticket.price | number: '1.2-2' }}</span>
                <span *ngIf="ticket.totalAvailable !== undefined"> &middot; {{ ticket.totalAvailable }} available</span>
              </div>
            </mat-list-item>
          </mat-list>
          <ng-template #noTickets>
            <p class="no-tickets">No ticket types configured for this event.</p>
          </ng-template>
        </div>
      </mat-card-content>

      <mat-card-actions>
        <button mat-stroked-button color="primary" type="button" (click)="startEdit(event)" [disabled]="editingEventId === event.id && submissionInProgress">
          <mat-icon>edit</mat-icon>
          <span>Edit</span>
        </button>
        <button mat-button color="warn" type="button" (click)="deleteEvent(event)" [disabled]="isDeleting(event.id)">
          <ng-container *ngIf="!isDeleting(event.id); else deletingSpinner">
            <mat-icon>delete</mat-icon>
            <span>Delete</span>
          </ng-container>
          <ng-template #deletingSpinner>
            <mat-progress-spinner class="inline-spinner" diameter="20" strokeWidth="3" mode="indeterminate"></mat-progress-spinner>
            <span>Deleting...</span>
          </ng-template>
        </button>
      </mat-card-actions>

      <div class="edit-panel" *ngIf="editingEventId === event.id && form">
        <form [formGroup]="form" (ngSubmit)="saveEdit()" class="event-form" novalidate>
          <section class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>Event name</mat-label>
              <input matInput formControlName="name" />
              <mat-error *ngIf="form.controls.name.hasError('required')">Name is required.</mat-error>
              <mat-error *ngIf="form.controls.name.hasError('maxlength')">Name is too long.</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Status</mat-label>
              <mat-select formControlName="status">
                <mat-option *ngFor="let status of statusOptions" [value]="status">{{ status }}</mat-option>
              </mat-select>
              <mat-error *ngIf="form.controls.status.hasError('required')">Status is required.</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Type</mat-label>
              <mat-select formControlName="type">
                <mat-option *ngFor="let type of typeOptions" [value]="type">{{ type }}</mat-option>
              </mat-select>
              <mat-error *ngIf="form.controls.type.hasError('required')">Type is required.</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Venue</mat-label>
              <input matInput formControlName="venue" />
              <mat-error *ngIf="form.controls.venue.hasError('required')">Venue is required.</mat-error>
              <mat-error *ngIf="form.controls.venue.hasError('maxlength')">Venue is too long.</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Event start</mat-label>
              <input matInput type="datetime-local" formControlName="start" />
              <mat-error *ngIf="form.controls.start.hasError('required')">Start is required.</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Event end</mat-label>
              <input matInput type="datetime-local" formControlName="end" />
              <mat-error *ngIf="form.controls.end.hasError('required')">End is required.</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Sales open</mat-label>
              <input matInput type="datetime-local" formControlName="salesStart" />
              <mat-hint>Optional</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Sales close</mat-label>
              <input matInput type="datetime-local" formControlName="salesEnd" />
              <mat-hint>Optional</mat-hint>
            </mat-form-field>
          </section>

          <mat-form-field appearance="outline" class="description-field">
            <mat-label>Description</mat-label>
            <textarea matInput formControlName="description" rows="3"></textarea>
          </mat-form-field>

          <mat-divider></mat-divider>

          <section class="ticket-type-section" formArrayName="ticketTypes" *ngIf="ticketTypes as ticketArray">
            <h2>Ticket types</h2>
            <p class="ticket-hint" *ngIf="!ticketArray.controls.length">No ticket types are linked to this event.</p>

            <div
              class="ticket-type-card"
              *ngFor="let ticketGroup of ticketArray.controls; let i = index; trackBy: trackTicketType"
              [formGroupName]="i"
            >
              <div class="ticket-type-header">
                <h3>Type {{ i + 1 }}</h3>
              </div>

              <div class="form-grid">
                <mat-form-field appearance="outline">
                  <mat-label>Ticket name</mat-label>
                  <input matInput formControlName="name" />
                  <mat-error *ngIf="ticketGroup.controls.name.hasError('required')">Ticket name is required.</mat-error>
                  <mat-error *ngIf="ticketGroup.controls.name.hasError('maxlength')">Name is too long.</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Price</mat-label>
                  <input matInput type="number" min="0" step="0.01" formControlName="price" />
                  <span matTextPrefix>$&nbsp;</span>
                  <mat-error *ngIf="ticketGroup.controls.price.hasError('required')">Price is required.</mat-error>
                  <mat-error *ngIf="ticketGroup.controls.price.hasError('min')">Price cannot be negative.</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Total available</mat-label>
                  <input matInput type="number" min="1" step="1" formControlName="totalAvailable" />
                  <mat-error *ngIf="ticketGroup.controls.totalAvailable.hasError('required')">Total is required.</mat-error>
                  <mat-error *ngIf="ticketGroup.controls.totalAvailable.hasError('min')">Need at least one ticket.</mat-error>
                </mat-form-field>
              </div>

              <mat-form-field appearance="outline">
                <mat-label>Description</mat-label>
                <textarea matInput formControlName="description" rows="2"></textarea>
              </mat-form-field>
            </div>
          </section>

          <div class="form-actions">
            <button mat-stroked-button type="button" (click)="cancelEdit()" [disabled]="submissionInProgress">
              <mat-icon>close</mat-icon>
              <span>Cancel</span>
            </button>
            <button mat-raised-button color="primary" type="submit" [disabled]="submissionInProgress">
              <ng-container *ngIf="!submissionInProgress; else saving">
                <mat-icon>save</mat-icon>
                <span>Save changes</span>
              </ng-container>
            </button>
            <ng-template #saving>
              <mat-progress-spinner class="inline-spinner" diameter="20" strokeWidth="3" mode="indeterminate"></mat-progress-spinner>
              <span>Saving...</span>
            </ng-template>
          </div>
        </form>
      </div>
    </mat-card>
  </section>

  <mat-paginator
    *ngIf="page && page.totalPages > 1"
    [length]="page.totalElements"
    [pageIndex]="page.number"
    [pageSize]="page.size"
    [pageSizeOptions]="[page.size]"
    (page)="onPageChange($event)"
  ></mat-paginator>

  <ng-template #noEvents>
    <div class="empty-state" *ngIf="!loading && !events.length && !error">
      <mat-icon>lightbulb</mat-icon>
      <h2>No events yet</h2>
      <p>Create your first event to start selling tickets.</p>
      <a mat-stroked-button color="accent" routerLink="/organizer/create-event">
        <mat-icon>add_circle</mat-icon>
        <span>Create an event</span>
      </a>
    </div>
  </ng-template>
</div>
