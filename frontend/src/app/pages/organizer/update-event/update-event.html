<section class="page page--wide organizer-event-form">
  <header class="page__header">
    <div class="page__intro">
      <h1 class="page__title">Update Event</h1>
      <p class="page__subtitle">Refresh event details, ticketing, and messaging before changes go live.</p>
    </div>
  </header>
  <mat-card appearance="outlined">
    <mat-card-header>
      <div mat-card-avatar class="card-avatar">
        <mat-icon>event</mat-icon>
      </div>
      <mat-card-title>Update Event</mat-card-title>
      <mat-card-subtitle>Revise schedules, ticketing, and messaging before publishing changes.</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      @if (loadError) {
        <div class="alert error">
          <mat-icon>error</mat-icon>
          <span>{{ loadError }}</span>
        </div>

        @if (!loading) {
          <div class="form-actions">
            <button mat-stroked-button color="accent" type="button" (click)="goToOrganizerEvents()">
              <mat-icon>event_available</mat-icon>
              <span>Back to events</span>
            </button>
          </div>
        }
      }

      @if (loading && !loadError) {
        <div class="loading-container">
          <mat-progress-spinner mode="indeterminate" diameter="48" strokeWidth="4"></mat-progress-spinner>
        </div>
      }

      @if (!loading && !loadError) {
        @if (submissionSuccess) {
          <div class="alert success">
            <mat-icon>check_circle</mat-icon>
            <span>{{ submissionSuccess }}</span>
          </div>
        }

        @if (submissionError) {
          <div class="alert error">
            <mat-icon>error</mat-icon>
            <span>{{ submissionError }}</span>
          </div>
        }

        <form [formGroup]="form" (ngSubmit)="onSubmit()" class="event-form" novalidate>
          <section class="form-section">
            <div class="section-header">
              <div>
                <h2>Event basics</h2>
                <p class="section-subtitle">Keep the core identity and location accurate for attendees.</p>
              </div>
            </div>
            <div class="form-grid form-grid--row">
              <mat-form-field appearance="outline">
                <mat-label>Event name</mat-label>
                <input matInput formControlName="name" placeholder="e.g. Summer Launch Meetup" />
                @if (form.controls.name.hasError('required')) {
                  <mat-error>Name is required.</mat-error>
                }
                @if (form.controls.name.hasError('maxlength')) {
                  <mat-error>Name is too long.</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Venue</mat-label>
                <input matInput formControlName="venue" placeholder="e.g. Skyline Auditorium" />
                @if (form.controls.venue.hasError('required')) {
                  <mat-error>Venue is required.</mat-error>
                }
                @if (form.controls.venue.hasError('maxlength')) {
                  <mat-error>Venue name is too long.</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Type</mat-label>
                <mat-select formControlName="type">
                  @for (type of typeOptions; track type) {
                    <mat-option [value]="type">{{ type }}</mat-option>
                  }
                </mat-select>
                @if (form.controls.type.hasError('required')) {
                  <mat-error>Type is required.</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Status</mat-label>
                <mat-select formControlName="status">
                  @for (status of statusOptions; track status) {
                    <mat-option [value]="status">{{ status }}</mat-option>
                  }
                </mat-select>
                @if (form.controls.status.hasError('required')) {
                  <mat-error>Status is required.</mat-error>
                }
              </mat-form-field>
            </div>
          </section>

          <mat-divider></mat-divider>

          <section class="form-section">
            <div class="section-header">
              <div>
                <h2>Schedule</h2>
                <p class="section-subtitle">Confirm when the doors open and close.</p>
              </div>
            </div>
            <div class="form-grid form-grid--row">
              <mat-form-field appearance="outline">
                <mat-label>Event start date</mat-label>
                <input matInput [matDatepicker]="startDatePicker" formControlName="startDate" />
                <mat-datepicker-toggle matIconSuffix [for]="startDatePicker"></mat-datepicker-toggle>
                <mat-datepicker #startDatePicker></mat-datepicker>
                @if (form.controls.startDate.hasError('required')) {
                  <mat-error>Start date is required.</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Event start time</mat-label>
                <input matInput [matTimepicker]="startTimePicker" formControlName="startTime" />
                <mat-timepicker-toggle matIconSuffix [for]="startTimePicker">
                  <mat-icon matTimepickerToggleIcon>schedule</mat-icon>
                </mat-timepicker-toggle>
                <mat-timepicker #startTimePicker/>
                @if (form.controls.startTime.hasError('required')) {
                  <mat-error>Start time is required.</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Event end date</mat-label>
                <input matInput [matDatepicker]="endDatePicker" formControlName="endDate" />
                <mat-datepicker-toggle matIconSuffix [for]="endDatePicker"></mat-datepicker-toggle>
                <mat-datepicker #endDatePicker></mat-datepicker>
                @if (form.controls.endDate.hasError('required')) {
                  <mat-error>End date is required.</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Event end time</mat-label>
                <input matInput [matTimepicker]="endTimePicker" formControlName="endTime" />
                <mat-timepicker-toggle matIconSuffix [for]="endTimePicker">
                  <mat-icon matTimepickerToggleIcon>schedule</mat-icon>
                </mat-timepicker-toggle>
                <mat-timepicker #endTimePicker/>
                @if (form.controls.endTime.hasError('required')) {
                  <mat-error>End time is required.</mat-error>
                }
              </mat-form-field>
            </div>
          </section>

          <mat-divider></mat-divider>

          <section class="form-section optional">
            <div class="section-header">
              <div>
                <h2>Ticket sales window</h2>
                <p class="section-subtitle">Set or remove ticket availability ranges.</p>
              </div>
              <button mat-stroked-button color="primary" type="button" (click)="toggleSalesWindowFields()">
                <mat-icon>{{ showSalesWindowFields ? 'close' : 'schedule' }}</mat-icon>
                <span>{{ showSalesWindowFields ? 'Remove sales window' : 'Add sales window' }}</span>
              </button>
            </div>
            @if (showSalesWindowFields) {
              <div class="form-grid form-grid--row">
              <mat-form-field appearance="outline">
                <mat-label>Sales open date</mat-label>
                <input matInput [matDatepicker]="salesStartDatePicker" formControlName="salesStartDate" />
                <mat-datepicker-toggle matIconSuffix [for]="salesStartDatePicker"></mat-datepicker-toggle>
                <mat-datepicker #salesStartDatePicker></mat-datepicker>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Sales open time</mat-label>
                <input matInput [matTimepicker]="salesStartTimePicker" formControlName="salesStartTime" />
                <mat-timepicker-toggle matIconSuffix [for]="salesStartTimePicker">
                  <mat-icon matTimepickerToggleIcon>schedule</mat-icon>
                </mat-timepicker-toggle>
                <mat-timepicker #salesStartTimePicker/>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Sales close date</mat-label>
                <input matInput [matDatepicker]="salesEndDatePicker" formControlName="salesEndDate" />
                <mat-datepicker-toggle matIconSuffix [for]="salesEndDatePicker"></mat-datepicker-toggle>
                <mat-datepicker #salesEndDatePicker></mat-datepicker>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Sales close time</mat-label>
                <input matInput [matTimepicker]="salesEndTimePicker" formControlName="salesEndTime" />
                <mat-timepicker-toggle matIconSuffix [for]="salesEndTimePicker">
                  <mat-icon matTimepickerToggleIcon>schedule</mat-icon>
                </mat-timepicker-toggle>
                <mat-timepicker #salesEndTimePicker/>
              </mat-form-field>
              </div>
            }
          </section>

          <mat-divider></mat-divider>

          <section class="form-section optional">
            <div class="section-header">
              <div>
                <h2>Event description</h2>
                <p class="section-subtitle">Update highlights, agendas, or key announcements.</p>
              </div>
              <button mat-stroked-button type="button" (click)="toggleDescriptionField()">
                <mat-icon>{{ showDescriptionField ? 'close' : 'notes' }}</mat-icon>
                <span>{{ showDescriptionField ? 'Remove description' : 'Add description' }}</span>
              </button>
            </div>
            @if (showDescriptionField) {
              <mat-form-field appearance="outline" class="description-field">
                <mat-label>Description</mat-label>
                <textarea
                  matInput
                  formControlName="description"
                  rows="4"
                  placeholder="Share highlights, schedule, or speaker line-up"
                ></textarea>
              </mat-form-field>
            }
          </section>

          <mat-divider></mat-divider>

          <section class="ticket-type-section">
            <div class="ticket-type-actions">
              <h2>Ticket types</h2>
              <button mat-stroked-button color="primary" type="button" (click)="addTicketType()">
                <mat-icon>add</mat-icon>
                <span>Add ticket type</span>
              </button>
            </div>

            <div formArrayName="ticketTypes">
              @for (ticketGroup of ticketTypes.controls; track trackByIndex($index)) {
                @let i = $index;
                <div class="ticket-type-card" [formGroupName]="i">
                  <div class="ticket-type-header">
                    <h3>Type {{ i + 1 }}</h3>
                    <button mat-icon-button color="warn" type="button" (click)="removeTicketType(i)" [disabled]="ticketTypes.length === 1">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>

                  <div class="form-grid">
                    <mat-form-field appearance="outline">
                      <mat-label>Ticket name</mat-label>
                      <input matInput formControlName="name" placeholder="e.g. General Admission" />
                      @if (ticketGroup.controls.name.hasError('required')) {
                        <mat-error>Ticket name is required.</mat-error>
                      }
                      @if (ticketGroup.controls.name.hasError('maxlength')) {
                        <mat-error>Name is too long.</mat-error>
                      }
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Price</mat-label>
                      <input matInput type="number" min="0" step="0.01" formControlName="price" />
                      <span matTextPrefix>$&nbsp;</span>
                      @if (ticketGroup.controls.price.hasError('required')) {
                        <mat-error>Price is required.</mat-error>
                      }
                      @if (ticketGroup.controls.price.hasError('min')) {
                        <mat-error>Price cannot be negative.</mat-error>
                      }
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Total available</mat-label>
                      <input matInput type="number" min="1" step="1" formControlName="totalAvailable" />
                      @if (ticketGroup.controls.totalAvailable.hasError('required')) {
                        <mat-error>Total is required.</mat-error>
                      }
                      @if (ticketGroup.controls.totalAvailable.hasError('min')) {
                        <mat-error>Need at least one ticket.</mat-error>
                      }
                    </mat-form-field>
                  </div>

                  <mat-form-field appearance="outline">
                    <mat-label>Description</mat-label>
                    <textarea matInput formControlName="description" rows="3" placeholder="Optional details for this ticket tier"></textarea>
                  </mat-form-field>
                </div>
              }
            </div>
          </section>

          <div class="form-actions">
            <button mat-stroked-button type="button" (click)="resetToLoadedEvent()">
              <mat-icon>history</mat-icon>
              <span>Reset changes</span>
            </button>
            <button mat-stroked-button color="accent" type="button" (click)="goToOrganizerEvents()">
              <mat-icon>event_available</mat-icon>
              <span>Back to events</span>
            </button>
            <button mat-stroked-button color="primary" type="submit" [disabled]="submissionInProgress">
              @if (submissionInProgress) {
                <mat-progress-spinner class="spinner" mode="indeterminate" diameter="18" strokeWidth="3"></mat-progress-spinner>
              } @else {
                <mat-icon>save</mat-icon>
              }
              <span>{{ submissionInProgress ? 'Savingâ€¦' : 'Save changes' }}</span>
            </button>
          </div>
        </form>
      }
    </mat-card-content>
  </mat-card>
</section>
