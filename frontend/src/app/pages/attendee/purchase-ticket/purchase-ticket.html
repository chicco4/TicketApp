<section class="purchase-ticket">
  @if (loading) {
    <div class="loading">
      <mat-spinner diameter="40"></mat-spinner>
      <span>Loading…</span>
    </div>
  } @else if (loadError) {
    <div class="error">{{ loadError }}</div>
    <button mat-button color="primary" (click)="goBack()">Back</button>
  } @else if (event && ticketType) {
    <mat-card appearance="outlined" class="purchase-card">
      <mat-card-header>
        <mat-card-title>Purchase Ticket</mat-card-title>
        <mat-card-subtitle>{{ event.name }}</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="ticket-summary">
          <div class="ticket-info">
            <h3>{{ ticketType.name }}</h3>
            <p class="description">{{ ticketType.description }}</p>
            <p class="price">{{ ticketType.price | currency }} per ticket</p>
          </div>

          <div class="event-info">
            <p><strong>Event:</strong> {{ event.name }}</p>
            <p><strong>Venue:</strong> {{ event.venue }}</p>
            <p><strong>Date:</strong> {{ event.start | date: 'medium' }}</p>
          </div>
        </div>

        <form [formGroup]="purchaseForm" (ngSubmit)="onSubmit()" class="purchase-form">
          @let quantityCtrl = purchaseForm.get('quantity');
          <mat-form-field appearance="outline">
            <mat-label>Quantity</mat-label>
            <input matInput type="number" formControlName="quantity" min="1" max="10">
            @if (quantityCtrl?.hasError('required')) {
              <mat-error>Quantity is required</mat-error>
            }
            @if (quantityCtrl?.hasError('min')) {
              <mat-error>Minimum quantity is 1</mat-error>
            }
            @if (quantityCtrl?.hasError('max')) {
              <mat-error>Maximum quantity is 10</mat-error>
            }
          </mat-form-field>

          <div class="total">
            <strong>Total:</strong>
            <span class="total-amount">{{ getTotalPrice() | currency }}</span>
          </div>
        </form>

        @if (purchaseError) {
          <div class="error">{{ purchaseError }}</div>
        }
      </mat-card-content>

      <mat-card-actions align="end">
        <button mat-button (click)="goBack()">Cancel</button>
        <button mat-raised-button color="primary" (click)="onSubmit()"
          [disabled]="!purchaseForm.valid || purchaseInProgress">
          {{ purchaseInProgress ? 'Processing…' : 'Complete Purchase' }}
        </button>
      </mat-card-actions>
    </mat-card>
  } @else {
    <div class="error">Ticket details are unavailable.</div>
    <button mat-button color="primary" (click)="goBack()">Back</button>
  }
</section>
